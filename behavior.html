<title>พฤติกรรมประหลาด</title>

<meta charset="utf-8">

<link rel="stylesheet" href="css/style.css">

<script src="js/script.js"></script>

<link rel="prev" href="tour.html">

<link rel="next" href="design.html">

<h2 id="api">พฤติกรรมประหลาด</h2>

<p>ท่านที่เริ่มต้นเล่นหุ้น หรือไม่ได้เล่นแต่มาอ่านข่าวหุ้น อาจจะเคยเจอบทวิเคราะห์แปลกๆ ทำนองว่า หุ้น ABC ตัวนี้ราคา ๒๐ บาท
  ถ้าราคาขึ้นไปถึง ๒๒ บาท  ก็ซื้อได้ แต่ถ้าลงมาต่ำกว่า
  ๑๙ บาท ให้รีบขายทิ้งทันที หรืออย่างวันนี้บริษัท XYZ ประกาศผลกำไรกระฉูด ให้รีบหาจังหวะขายทิ้งโดยด่วน ซึ่งคนที่เล่นมานานแล้ว โดนมาแล้ว ก็จะเริ่มเข้าใจถึงตรรกกะ
  กระบวนการเหล่านี้ การซื้อขายหุ้น ไม่เหมือนการซื้อขายสินค้าทั่วๆไป ที่เราซื้อมาต้นทุน ๒๐ บาท
  มีคนมาให้ราคา ๒๒ บาท ย่อมจะต้องรีบขาย ส่วนถ้ามีคนมาต่อ ๑๙ บาท มีแต่ต้องรีบซื้อของถูกมาเก็บไว้
  อะไรแบบนี้ ตลาดหุ้น
  เป็นตลาดที่เรียกว่าคอมมอดิตี้ กล่าวคือมีผู้ซื้อมากราย และผู้ขายมากราย ตลาดไม่สนใจว่าใครซื้ออะไรมาเท่าไร ต้นทุนเท่าไร วันนี้พอใจจะซื้อขายกัน ๑๐๐ บาท ท่านก็ขายได้ ๑๐๐ บาท
  อีกวันมหาชนพอใจจุ๋มจิ๋มแค่ ๕ บาท ท่านก็ขายได้ ๕ บาท ทั้งๆที่เป็นของเดียวกัน บริษัทมันก็อยู่ของมันอย่างเดิม พนักงานเดิมๆ ยอดขายเท่าเดิม

<p>ความพอใจ หรือศัพท์หรูๆเรียกว่าอุปสงค์ และอุปทาน หรือฝรั่งเรียกว่าซัพพลาย กับดีมานด์ นี้ต่างหาก เป็นตัวกำหนดราคา ท่านจะได้ หรือจะเสีย ก็ขึ้นกับความพอใจ
  อันนี้นี่เอง ลองนึกสภาพตลาดเหมือนกับเป็นท้องทะเล
  อันกว้างใหญ่ นักลงทุนก็เหมือนกับปลา มีทั้งปลาเล็ก ปลาใหญ่ กฏของตลาด ก็เป็นเช่นเดียวกับกฏของทะเล
  นั่นคือ ปลาใหญ่ ย่อมกินปลาเล็ก ปลาใหญ่ตัวหนึ่งที่รู้จักกันดี ก็คือปลาฉลามที่ได้ชื่อว่าเป็นนักล่าแห่งท้องทะเล กินปลาเล็กได้แทบทุกชนิด วันดีคืนดียังกินหมา แมว คน
  ได้อีก แต่มีปลาตัวหนึ่งที่มันอาศัยเกาะไปกับท้องฉลาม เราเรียกว่าปลาเหาฉลามหรือรีโมรา ไอ้ตัวนี้เกาะอยู่กับท้องฉลาม ฉลามจะกินก็กินไม่ค่อยถนัด แถมเวลาฉลามต้อนเหยื่อมา
  หรือโจมตรีเหยื่อจนได้ที่แล้ว เจ้าเหาฉลามยังสามารถอาศัยความคล่องตัวแย่งกินซะก่อน หรือจะกินหลังจากเจ้าฉลามอิ่มไปก็ยังได้

<div class="figure" id="figure/1">
<img src="behavior/remora.jpg">
<p class="caption">รูปประกอบ ๑. เหาฉลาม
</div>

<p>ในบทความนี้จึงขอเน้นกลุ่มนักลงทุนรายย่อย ที่เป็นปลาเล็กปอดเล็ก หลักแสนจนถึงหลักสิบล้าน ทำอย่างไรถึงจะทำมาหากินอยู่ในท้องทะเลได้ตามอัตภาพ หรืออย่างน้อย
  ไม่ต้องถูกฉลามฟัดโดยไม่รู้สี่รู้แปดอะไรทั้งนั้น โดยรวมกลยุทธ์ทั้งพื้นฐานเทคนิคัลมาอธิบายกันแบบบ้านๆ จำกันง่ายๆ
<p>นักลงทุนทั่วไป มีขั้นตอนการเล่นหุ้นแค่ ๒ อย่าง คือ ซื้อ กับขาย แต่สำหรับนักลงทุนเหาฉลาม ท่านมีกิจกรรมที่จะต้องทำถึง ๕ อย่างดังต่อไปนี้

<ul>
  <li>เตรียมพร้อม</li>
  <li>บุก</li>
  <li>ดูด</li>
  <li>คัทลอส - ยอมเสียอวัยวะเพื่อรักษาชีวิต</li>
  <li>โซ้ย</li>
</ul>

<h3 id="dormant">เตรียมพร้อม</h3>
<p>ทราบไหมครับว่าถ้าท่านลงทุน ๑๐๐ บาทในตลาดหุ้นไทยวันที่ ๑ มกราคม ๒๕๓๗ จนถึงปัจจุบัน ๑๖ กันยายน ๒๕๕๗ ผ่านไป ๒๐ กว่าปี เงินลงทุนของท่านจะงอกเงยขึ้นเป็น ...
<p>... เป็น ...
<p>... เป็น ...
<p>๙๓ บาท !!!

<p>นี่หมายถึงคนที่ใจหินมากๆนะครับ ที่เป็นชาวเขาตัวจริงถึงจะเก็บไว้ยี่สิบกว่าปีจนรอวันที่ตลาดกระเตื้องขึ้นมาจากจุดสูงสุด ๑,๖๘๒ จุดตอนต้นปี ๓๗
  ส่วนมากถ้าใจไม่ถึงเก็นไว้ห้าปี สิบปี ยิ่งโดนหนักกว่านี้อีกครับ

<div class="aside note">
  <p>คือยกตัวอย่างให้เห็นนะครับ ว่า ๒๐ ปีที่ผ่านมามันเป็นอย่างนี้ จะหาว่าแกล้งเอากรณีที่สุดๆมาเทียบก็ต้องยอมรับว่าตลาดทุนเมืองไทยมันเป็นอย่างนี้จริงๆ
    เหาฉลามมือใหม่จะได้เตรียมตัวเตรียมใจ
  <div class="figure" id="figure/2">
    <img src="behavior/set94_14.png">
    <p class="caption">รูปประกอบ ๒. ดรรชนีตลาดหลักทรัพย์ปี ๒๕๓๗ - ๒๕๕๗
  </div>
</div>

<p>เห็นเฉลยกันชัดๆอย่างนี้แล้วลองมาดูครับว่าเราควรจะเล่นอย่างไร

<div class="figure" id="figure/3">
  <img src="behavior/buy98.png">
  <p class="caption">รูปประกอบ ๓. ซื้อ ๑ ครั้งเดือนมิถุนายน ๒๕๔๑
</div>

<p>อย่างแรกเลยคือซื้อครั้งเดียวตอนที่ต่ำสุด ๓๐ มิถุนายน ๒๕๔๑ ที่ ๒๖๗ จุด แล้วถือมาตลอดถึงตอนนี้ ๑,๕๖๘ จุด กำไร  ๑,๓๐๑ (๔๘๗ %)
  ถือไว้ ๑๖ ปี กำไรเกือบ ๕ เท่า ก็พอใช้ได้นะครับ


<p>Now with the <code>-v</code> option, CouchDB’s reply (with only the important bits shown) looks like this:

<pre>
&gt; PUT /albums/70b50bfa0a4b3aed1f8aff9e92dc16a0 HTTP/1.1
&gt;
&lt; HTTP/1.1 201 Created
&lt; Location: http://127.0.0.1:5984/albums/70b50bfa0a4b3aed1f8aff9e92dc16a0
&lt; Etag: "1-2248288203"
&lt;
{"ok":true,"id":"70b50bfa0a4b3aed1f8aff9e92dc16a0","rev":"1-2248288203"}
</pre>

<p>We’re getting back the <code>201 Created</code> HTTP status code in the response headers, as we saw earlier when we created a database. The <code>Location</code> header gives us a full URL to our newly created document. And there’s a new header. An Etag in HTTP-speak identifies a specific version of a resource. In this case, it identifies a specific version (the first one) of our new document. Sound familiar? Yes, conceptually, an Etag is the same as a CouchDB document revision number, and it shouldn’t come as a surprise that CouchDB uses revision numbers for Etags. Etags are useful for caching infrastructures. We’ll learn how to use them in <a href="show.html">Chapter 8, Show Functions</a>.

<h5 id="attachments">Attachments</h5>

<p>CouchDB documents can have attachments just like an email message can have attachments. An attachment is identified by a name and includes its MIME type (or Content-Type) and the number of bytes the attachment contains. Attachments can be any data. It is easiest to think about attachments as files attached to a document. These files can be text, images, Word documents, music, or movie files. Let’s make one.

<p>Attachments get their own URL where you can upload data. Say we want to add the album artwork to the <code>6e1295ed6c29495e54cc05947f18c8af</code> document (“There is Nothing Left to Lose”), and let’s also say the artwork is in a file <code>artwork.jpg</code> in the current directory:

<pre>
&gt; curl -vX PUT http://127.0.0.1:5984/albums/6e1295ed6c29495e54cc05947f18c8af/ artwork.jpg?rev=2-2739352689 --data-binary @artwork.jpg -H "Content-Type: image/jpg"
</pre>

<p>The <code>-d@</code> option tells <code>curl</code> to read a file’s contents into the HTTP request body. We’re using the <code>-H</code> option to tell CouchDB that we’re uploading a JPEG file. CouchDB will keep this information around and will send the appropriate header when requesting this attachment; in case of an image like this, a browser will render the image instead of offering you the data for download. This will come in handy later. Note that you need to provide the current revision number of the document you’re attaching the artwork to, just as if you would update the document. Because, after all, attaching some data is changing the document.

<p>You should now see your artwork image if you point your browser to <code>http://127.0.0.1:5984/albums/6e1295ed6c29495e54cc05947f18c8af/artwork.jpg</code>.

<p>If you request the document again, you’ll see a new member:

<pre>
curl http://127.0.0.1:5984/albums/6e1295ed6c29495e54cc05947f18c8af
</pre>

<p>CouchDB replies:

<pre>
{"_id":"6e1295ed6c29495e54cc05947f18c8af","_rev":"3-131533518","title": "There is Nothing Left to Lose","artist":"Foo Fighters","year":"1997","_attachments":{"artwork.jpg":{"stub":true,"content_type":"image/jpg","length":52450}}}
</pre>

<p><code>_attachments</code> is a list of keys and values where the values are JSON objects containing the attachment metadata. <code>stub=true</code> tells us that this entry is just the metadata. If we use the <code>?attachments=true</code> HTTP option when requesting this document, we’d get a Base64-encoded string containing the attachment data.

<p>We’ll have a look at more document request options later as we explore more features of CouchDB, such as replication, which is the next topic.

<h3 id="replication">Replication</h3>

<p>CouchDB replication is a mechanism to synchronize databases. Much like <code>rsync</code> synchronizes two directories locally or over a network, replication synchronizes two databases locally or remotely.

<p>In a simple POST request, you tell CouchDB the <em>source</em> and the <em>target</em> of a replication and CouchDB will figure out which documents and new document revisions are on <em>source</em> that are not yet on <em>target</em>, and will proceed to move the missing documents and revisions over.

<p>We’ll take an in-depth look at replication later in the book; in this chapter, we’ll just show you how to use it.

<p>First, we’ll create a target database. Note that CouchDB won’t automatically create a target database for you, and will return a replication failure if the target doesn’t exist (likewise for the source, but that mistake isn’t as easy to make):

<pre>
curl -X PUT http://127.0.0.1:5984/albums-replica
</pre>

<p>Now we can use the database <code>albums-replica</code> as a replication target:

<pre>
curl -vX POST http://127.0.0.1:5984/_replicate -d '{"source":"albums","target":"albums-replica"}'
</pre>

<div class="aside note">

<p>As of version 0.11, CouchDB supports the option <code>"create_target":true</code> placed in the JSON POSTed to the <code>_replicate</code> URL. It implicitly creates the target database if it doesn’t exist.

</div>

<p>CouchDB replies (this time we formatted the output so you can read it more easily):

<pre>
{
  "history": [
    {
      "start_last_seq": 0,
      "missing_found": 2,
      "docs_read": 2,
      "end_last_seq": 5,
      "missing_checked": 2,
      "docs_written": 2,
      "doc_write_failures": 0,
      "end_time": "Sat, 11 Jul 2009 17:36:21 GMT",
      "start_time": "Sat, 11 Jul 2009 17:36:20 GMT"
    }
  ],
  "source_last_seq": 5,
  "session_id": "924e75e914392343de89c99d29d06671",
  "ok": true
}
</pre>

<p>CouchDB maintains a <em>session history</em> of replications. The response for a replication request contains the history entry for this <em>replication session</em>. It is also worth noting that the request for replication will stay <em>open</em> until replication closes. If you have a lot of documents, it’ll take a while until they are all replicated and you won’t get back the replication response until all documents are replicated. It is important to note that replication replicates the database only as it was at the point in time when replication was started. So, any additions, modifications, or deletions subsequent to the start of replication will not be replicated.

<p>We’ll punt on the details again—the <code>"ok": true</code> at the end tells us all went well. If you now have a look at the <code>albums-replica</code> database, you should see all the documents that you created in the <code>albums</code> database. Neat, eh?

<p>What you just did is called <em>local replication</em> in CouchDB terms. You created a local copy of a database. This is useful for backups or to keep snapshots of a specific state of your data around for later. You might want to do this if you are developing your applications but want to be able to roll back to a stable version of your code and data.

<p>There are more types of replication useful in other situations. The <code>source</code> and <code>target</code> members of our replication request are actually links (like in HTML) and so far we’ve seen links relative to the server we’re working on (hence <em>local</em>). You can also specify a remote database as the target:

<pre>
curl -vX POST http://127.0.0.1:5984/_replicate -d '{"source":"albums","target":"http://127.0.0.1:5984/albums-replica"}'
</pre>

<p>Using a local <code>source</code> and a remote <code>target</code> database is called <em>push replication</em>. We’re pushing changes to a remote server.

<div class="aside note">

<p>Since we don’t have a second CouchDB server around just yet, we’ll just use the absolute address of our single server, but you should be able to infer from this that you can put any remote server in there.

</div>

<p>This is great for sharing local changes with remote servers or buddies next door.

<p>You can also use a remote <code>source</code> and a local <code>target</code> to do a <em>pull replication</em>. This is great for getting the latest changes from a server that is used by others:

<pre>
curl -vX POST http://127.0.0.1:5984/_replicate -d '{"source":"http://127.0.0.1:5984/albums-replica","target":"albums"}'
</pre>

<p>Finally, you can run <em>remote replication</em>, which is mostly useful for management operations:

<pre>
curl -vX POST http://127.0.0.1:5984/_replicate -d '{"source":"http://127.0.0.1:5984/albums","target":"http://127.0.0.1:5984/albums-replica"}'
</pre>

<div class="aside note">

<p><strong>CouchDB and REST</strong>

<p>CouchDB prides itself on having a <em>RESTful API</em>, but these replication requests don’t look very RESTy to the trained eye. What’s up with that? While CouchDB’s core database, document, and attachment API are RESTful, not all of CouchDB’s API is. The replication API is one example. There are more, as we’ll see later in the book.

<p>Why are there RESTful and non-RESTful APIs mixed up here? Have the developers been too lazy to go REST all the way? Remember, REST is an architectural style that lends itself to certain architectures (such as the CouchDB document API). But it is not a one-size-fits-all. Triggering an event like replication does not make a whole lot of sense in the REST world. It is more like a traditional remote procedure call. And there is nothing wrong with this.

<p>We very much believe in the “use the right tool for the job” philosophy, and REST does not fit every job. For support, we refer to Leonard Richardson and Sam Ruby who wrote <a href="http://oreilly.com/catalog/9780596529260">RESTful Web Services</a> (O’Reilly), as they share our view.

</div>

<h3 id="wrap">Wrapping Up</h3>

<p>This is still not the full CouchDB API, but we discussed the essentials in great detail. We’re going to fill in the blanks as we go. For now, we believe you’re ready to start building CouchDB applications.
